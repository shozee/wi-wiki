このwikiについて
================

はじめに
--------

ディレクトリ構造を持ったドキュメント作成に向いたwikiエンジンです。
次のような特徴があります。

- [markdown](https://ja.wikipedia.org/wiki/Markdown)記法
  - 書きやすい、読みやすい
  - markdownから他の形式に変換するツールが豊富
    - 書いたドキュメントを他の用途に再利用しやすい
- シンプル
  - wikiエンジンは400行程度のbashスクリプト
  - DB不要。wikiコンテンツはテキスト形式でgit管理。
    - ページの管理やマージはgitまかせ
- ポータブル
  - cgiが実行可能なサーバなら大体どこでも動く
    - サーバが無くてもエディタで直接編集
  - wikiのコンテンツとエンジンが独立
    - 混じり気の無いドキュメントフォルダと、外側からコンテンツを編集するcgi


ディレクトリ構造
----------------

```
  ├── cgi-bin/
  │   ├── subsh
  │   │   └── markdown   ... markdownパーサ
  │   └── wi.sh          ... wiki本体
  ├── contents/          ... wikiコンテンツ格納ディレクトリ(以下は一例)
  │   ├── Home.md
  │   ├── public/        ... ここは共有したくないディレクトリ
  │   │   └── note1.md
  │   ├── private/
  │   │   └── note2.md   ... ここは共有するディレクトリ
  ├── data/              ... html作成のための部品置き場
  │   ├── FOOTER
  │   └── HEADER
  ├── doc/               ... GPLのお約束
  │   ├── COPYING
  │   └── README
  └── wrapper/           ... webからアクセスしたときのパーミッション設定に必要なラッパ
      ├── Makefile
      └── wiki.c
```

インストール手順
----------------

1. subsh/以下にmarkdown形式からhtml形式へ変換するパーサを置きます。
   標準で[John Gruberのperlスクリプト](https://daringfireball.net/projects/markdown/)を使うようになっていますので、これで良いなら特に作業は必要ありません。
   sundownなど、別のものに変えても良いと思います。
2. apacheからcgiアクセスを考えている人はwrapper/の下でmakeして出来るバイナリ実行ファイルをcgi-bin以下にコピーしてください。
   出来たバイナリに対してchmod u+sも必要です。バイナリの中で、setuidしてからwi.shを実行しています。
   こうすると、webからcgiアクセスした時にファイルの所有者が"apache"だったり、"www-data"になったりするのを避けることが出来ます。apache側でsuExecの設定などがされている場合はこのステップは不要です。
3. mkdir contentsして、以下に管理したいリポジトリごとにgit initして下さい。
4. 以上です！


ユーザー管理
------------

cgi-bin以下のディレクトリに.htpasswd, .htdigestなどと.htaccessを置いて認証をかけてください。


w3mからlocal CGIでアクセス
--------------------------

w3mにはローカルCGIという機能があって、ターミナルからwebを介さずにCGIへアクセスできます。
w3mを開き、"o"をタイプすると設定画面が開きますので、そこのcgi-binの置き場、という項目にこのwikiのPATHを設定します。
このwikiのCGIはUTF-8のhtmlを吐きますので、例えば、
  
    $ LANG=ja_JP.UTF-8 w3m file:/cgi-bin/wiki.cgi

などとすれば日本語もバッチリです。(ただし日本語対応ターミナルは必要)
ただ、gitに慣れた人は直接ディレクトリを覗いて直接リポジトリを編集するほうをオススメ。

注意点など
----------

- 現在、markdownテキストのみが管理対象です
  - png, ppt, pdfなどはgitリポジトリの肥大化を避けるためコミットしないようになっています。


開発のきっかけ
--------------

得た知見を文書にして残すことは大切だと思っています。日頃から、wikiを便利に使っています。
十年超の職歴の中でたくさんwikiを使ってきました。グループで共有して使うもの、私個人で使ったりしたものもありました。
ただし、長年使った経験から、使い勝手を改善したいなと思うところも出てきました。

まず、webサーバーは定期的に更新されます。
wikiエンジンが特定のバージョンのスクリプト言語やデータベースに依存する、といった場合は計算機間の移行が大変です。
もし貴重なドキュメントが計算機の都合で失なわれてしまうとしたら、ちょっと悲しい。最新の知識を蓄えることも大事ですが、昔の人(失礼！)の苦労や経験から学ぶこは多いと思います。

そこで、ドキュメントを生成するための道具と、ドキュメント自体とを、*独立*にできれば良いなと思うようになりました。
前者はころころ変わって良いのかもしれませんが、後者は時代を問わず通用するものがあります。このwikiエンジンが動かないとドキュメントが見られない、という事を避けたい。
異動の多い職場では長期的に維持しやすいwikiが好まれると思いますので、ここは敢えて知見の共有に特化した低機能なwikiを目指すのはどうでしょう。
思えば、知見の共有という目的だけに限れば、言葉や図が残っていれば良いのでテキストや画像ファイル以外のものは本来不要でしょう。それだけならファイルのコピーで済むので移植も容易です。
また、コンテンツが独立していればwikiエンジンが変わったり失われても中身には影響が無いので、維持しやすいと思いました。

計算機に限らず、人もまた、定期的に異動するものです。
私自身、あちこち(海外含む)動く、根無し草なので、そのうち所属するグループごとのwikiだけじゃなくて自分用のポータブルなメモ作成システムが欲しいと思うようになりました。
欲ばりですが、個人に属するドキュメントと、オンラインで他者と協力して作っているドキュメントが一緒くたに扱えると良いなと思いました。ドキュメントの分散管理です。
例えば、自分用のメモを共有用に整形して転載するのが簡単に出来るように、同じwikiの中で、個人ドキュメントと、グループのメンバーとの共有ドキュメントが共存しつつ、別リポジトリとしてgit管理されて、片方は共有リポジトリと同期、もう片方は個人リポジトリと同期しているような状態が理想です。

すでに書いていますが、今はgitという便利なものがありますので、これをドキュメントの履歴管理や同期のためのツールとしてありがたく使わせていただきつつ、自分のしたいことをミニマムに実装してみたのが本wikiになります。
簡単に言えば、ドキュメントの入ったgitリポジトリを、リポジトリの外から操作するだけの簡単なcgiです。

もともと、[Wi! wiki](https://github.com/jimenezrick/wi-wiki)というGPLソフトウェアがあって、これに対して日本語化やファイル添付機能、相対ディレクトリ参照などの機能を追加しています。bashで書かれていたので、理解も移植もしやすい点でかなり理想に近かったので一目惚れ。本家の更新が止まっているのが残念ですが、問題ありません。たかだか数百行のbashなので問題無く今後も維持できるでしょう。

以上、駄文ですが、これを見て、いやいやもっとドキュメント管理の仕方がある、と他の人が思って行動を起こせたなら、この文書自体も後世に貢献できたことになります。
皆さん、良いドキュメントライフを。
